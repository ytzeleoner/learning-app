<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App de Aprendizaje - Repaso Espaciado</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue-draggable-next@2.2.1/dist/vue-draggable-next.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- Reemplazar gapi con Google Identity Services -->
  <script async defer src="https://accounts.google.com/gsi/client"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div id="app" class="container mx-auto p-4 max-w-4xl min-h-screen">
    <!-- Modal para ingresar SPREADSHEET_ID, API_KEY y Client ID -->
    <div v-if="mostrarModalCredenciales" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-md w-full">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Configuración de Google Sheets</h3>
        <p class="text-gray-600 mb-4">Por favor, ingresa el ID de tu hoja de Google Sheets, la clave de API de Google y el Client ID de OAuth.</p>
        <div class="space-y-4">
          <div>
            <label class="block text-gray-700 font-medium">Spreadsheet ID</label>
            <input
              v-model="tempSpreadsheetId"
              type="text"
              placeholder="Ej: 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms"
              class="w-full p-2 border rounded"
            >
          </div>
          <div>
            <label class="block text-gray-700 font-medium">API Key</label>
            <input
              v-model="tempApiKey"
              type="text"
              placeholder="Ej: AIzaSyCoUUk23MoqS2KzVfv8vYwpI-sX4seP1KA"
              class="w-full p-2 border rounded"
            >
          </div>
          <div>
            <label class="block text-gray-700 font-medium">OAuth Client ID</label>
            <input
              v-model="tempClientId"
              type="text"
              placeholder="Ej: YOUR_CLIENT_ID.apps.googleusercontent.com"
              class="w-full p-2 border rounded"
            >
          </div>
          <button
            @click="guardarCredenciales"
            :disabled="!tempSpreadsheetId || !tempApiKey || !tempClientId"
            class="w-full py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
          >
            Guardar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal para iniciar sesión con Google -->
    <div v-if="mostrarModalAuth" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-md w-full">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Iniciar Sesión con Google</h3>
        <p class="text-gray-600 mb-4">Necesitamos autenticarte para guardar tu progreso en Google Sheets.</p>
        <div class="flex justify-between">
          <button
            @click="iniciarSesionGoogle"
            class="py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
          >
            Iniciar Sesión
          </button>
          <button
            @click="cerrarModalAuth"
            class="py-2 px-4 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- ... (resto del HTML igual, incluyendo modal de userId, header, tabs, vistas, etc.) ... -->
  </div>

  <script>
    const { createApp, ref, onMounted, reactive } = Vue;

    createApp({
      setup() {
        // Refs para datos
        const areas = ref([]);
        const conocimientos = ref([]);
        const temas = ref([]);
        const preguntas = ref([]);

        // Progresos y gamificación
        const progresos = ref([]);
        const respuestaSeleccionada = reactive({});
        const mostrarModal = ref(false);
        const modalEsCorrecto = ref(false);
        const modalNivel = ref(0);
        const mostrarModalReset = ref(false);
        const puntosTotales = ref(0);
        const insignias = ref([]);
        const preguntaActual = ref(null);

        // Estado para vistas
        const vistaActual = ref('diario');
        const temaSeleccionado = ref(null);
        const preguntaActualIndex = ref(0);
        const preguntasCuestionario = ref([]);

        // Estado para credenciales de Google Sheets
        const mostrarModalCredenciales = ref(false);
        const tempSpreadsheetId = ref('');
        const tempApiKey = ref('');
        const tempClientId = ref('');
        const spreadsheetId = ref('');
        const apiKey = ref('');
        const clientId = ref('');

        // Estado para autenticación
        const mostrarModalAuth = ref(false);
        const accessToken = ref(null);
        const isSignedIn = ref(false);

        // Estado para userId
        const userId = ref('');
        const tempUserId = ref('');
        const mostrarModalUserId = ref(false);

        // Expandir secciones en explorar
        const expanded = ref({
          area: {},
          conocimiento: {},
          tema: {}
        });

        // Inicializar Google Identity Services
        const initGoogleAuth = () => {
          return new Promise((resolve) => {
            console.log('Initializing Google Identity Services with clientId:', clientId.value);
            if (!window.google) {
              console.error('Google Identity Services library not loaded');
              mostrarModalAuth.value = true;
              resolve();
              return;
            }
            // Inicializar cliente OAuth
            const client = google.accounts.oauth2.initTokenClient({
              client_id: clientId.value,
              scope: 'https://www.googleapis.com/auth/spreadsheets',
              callback: (response) => {
                console.log('OAuth callback response:', response);
                if (response.access_token) {
                  accessToken.value = response.access_token;
                  isSignedIn.value = true;
                  console.log('Access token obtained:', accessToken.value);
                  mostrarModalAuth.value = false;
                  // Reintentar guardar progresos si el modal estaba abierto
                  guardarProgresosEnSheets();
                } else {
                  console.error('No access token received:', response.error || 'Unknown error');
                  isSignedIn.value = false;
                  accessToken.value = null;
                  mostrarModalAuth.value = true;
                }
              },
              error_callback: (error) => {
                console.error('OAuth error:', JSON.stringify(error, null, 2));
                isSignedIn.value = false;
                accessToken.value = null;
                mostrarModalAuth.value = true;
              }
            });
            window.googleAuthClient = client; // Guardar cliente para usarlo en iniciarSesionGoogle
            console.log('Google Identity Services initialized');
            resolve();
          });
        };

        // Iniciar sesión con Google
        const iniciarSesionGoogle = () => {
          console.log('Attempting Google sign-in');
          if (!window.googleAuthClient) {
            console.error('Google auth client not initialized');
            mostrarModalAuth.value = true;
            return;
          }
          window.googleAuthClient.requestAccessToken();
        };

        // Cerrar modal de autenticación
        const cerrarModalAuth = () => {
          console.log('Closing auth modal');
          mostrarModalAuth.value = false;
          // Guardar en localStorage como fallback
          localStorage.setItem('progresos', JSON.stringify(progresos.value));
          localStorage.setItem('puntos', puntosTotales.value.toString());
          localStorage.setItem('insignias', JSON.stringify(insignias.value));
        };

        // Generar o cargar userId
        const cargarUserId = () => {
          let savedUserId = localStorage.getItem('userId');
          if (!savedUserId) {
            savedUserId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('userId', savedUserId);
          }
          userId.value = savedUserId;
          tempUserId.value = savedUserId;
          mostrarModalUserId.value = true;
        };

        // Guardar userId y recargar progresos
        const guardarUserId = async () => {
          if (tempUserId.value) {
            userId.value = tempUserId.value;
            localStorage.setItem('userId', userId.value);
            mostrarModalUserId.value = false;
            await cargarProgresosDesdeSheets();
            calcularPendientes();
            actualizarInsignias();
          }
        };

        // Cargar credenciales desde localStorage
        const cargarCredenciales = async () => {
          const savedSpreadsheetId = localStorage.getItem('spreadsheetId');
          const savedApiKey = localStorage.getItem('apiKey');
          const savedClientId = localStorage.getItem('clientId');
          if (savedSpreadsheetId && savedApiKey && savedClientId) {
            spreadsheetId.value = savedSpreadsheetId;
            apiKey.value = savedApiKey;
            clientId.value = savedClientId;
            await initGoogleAuth();
            return true;
          }
          mostrarModalCredenciales.value = true;
          return false;
        };

        // Guardar credenciales en localStorage
        const guardarCredenciales = async () => {
          if (tempSpreadsheetId.value && tempApiKey.value && tempClientId.value) {
            localStorage.setItem('spreadsheetId', tempSpreadsheetId.value);
            localStorage.setItem('apiKey', tempApiKey.value);
            localStorage.setItem('clientId', tempClientId.value);
            spreadsheetId.value = tempSpreadsheetId.value;
            apiKey.value = tempApiKey.value;
            clientId.value = tempClientId.value;
            mostrarModalCredenciales.value = false;
            await initGoogleAuth();
            await cargarDatosSheets();
            cargarUserId();
          }
        };

        // ... (resto del código igual: cargarProgresosDesdeSheets, guardarProgresosEnSheets, fetchSheetData, cargarDatosSheets, toggleExpand, iniciarCuestionario, getIntervalo, guardarProgresos, calcularPendientes, getRespuestaUsuario, getRespuestaCorrecta, responderPregunta, siguientePregunta, finalizarRespuesta, cerrarModal, getComponentForType, handleRespuesta, getAreaId, getAreaNombre, getAreaColor, getNivel, getConocimientosByArea, getTemasByConocimiento, getPreguntasByTema, getTemaNombre, calcularProgresoTema, getPreguntaTexto, getPreguntaTemaId, contarPreguntasArea, contarAprendidasArea, calcularProgresoArea, actualizarInsignias, confirmarReset) ...

        // Cargar datos iniciales
        onMounted(async () => {
          if (await cargarCredenciales()) {
            await cargarDatosSheets();
            cargarUserId();
          }
          window.scrollTo(0, 0);
        });

        return {
          areas,
          conocimientos,
          temas,
          preguntas,
          progresos,
          preguntasPendientes,
          respuestaSeleccionada,
          vistaActual,
          expanded,
          temaSeleccionado,
          preguntaActualIndex,
          preguntasCuestionario,
          mostrarModal,
          modalEsCorrecto,
          modalNivel,
          mostrarModalReset,
          puntosTotales,
          insignias,
          preguntaActual,
          mostrarModalCredenciales,
          tempSpreadsheetId,
          tempApiKey,
          tempClientId,
          spreadsheetId,
          apiKey,
          clientId,
          mostrarModalAuth,
          isSignedIn,
          accessToken,
          userId,
          tempUserId,
          mostrarModalUserId,
          toggleExpand,
          iniciarCuestionario,
          responderPregunta,
          siguientePregunta,
          finalizarRespuesta,
          cerrarModal,
          confirmarReset,
          guardarCredenciales,
          guardarUserId,
          iniciarSesionGoogle,
          cerrarModalAuth,
          calcularProgresoArea,
          contarAprendidasArea,
          contarPreguntasArea,
          calcularProgresoTema,
          getAreaId,
          getAreaNombre,
          getAreaColor,
          getNivel,
          getConocimientosByArea,
          getTemasByConocimiento,
          getPreguntasByTema,
          getTemaNombre,
          getPreguntaTexto,
          getPreguntaTemaId,
          getComponentForType,
          handleRespuesta,
          getRespuestaUsuario,
          getRespuestaCorrecta
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
